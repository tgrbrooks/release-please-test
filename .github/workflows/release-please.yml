name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  NPM_TOKEN: ${{secrets.NPM_TOKEN}}

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      package_release_created: ${{ steps.release.outputs['packages/release-please-test-pkg--release_created'] }}
      package_2_release_created: ${{ steps.release.outputs['packages/test-pkg-2--release_created'] }}
      candidate_version: ${{ steps.parse-versions.outputs.root_version }}
      package_candidate_version: ${{ steps.parse-versions.outputs.package_version }}
      package_2_candidate_version: ${{ steps.parse-versions.outputs.package_2_version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          target-branch: main
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
      - name: Parse package versions from PRs
        id: parse-versions
        if: steps.release.outputs.prs != ''
        run: |
          PRS_JSON='${{ toJSON(steps.release.outputs.prs) }}'
          # Parse JSON and extract the body from the first PR
          PR_BODY=$(echo "$PRS_JSON" | jq -r '.[0].body // empty' 2>/dev/null || echo "$PRS_JSON")
          
          # Extract version numbers from patterns like:
          # <details><summary>root: 0.6.0</summary>
          # <details><summary>package: 1.0.3</summary>
          # <details><summary>package-2: 0.2.1</summary>
          
          ROOT_VERSION=$(echo "$PR_BODY" | sed -n 's/.*root:[[:space:]]*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p' | head -n1)
          echo "root_version=$ROOT_VERSION" >> $GITHUB_OUTPUT
          PACKAGE_VERSION=$(echo "$PR_BODY" | sed -n 's/.*package:[[:space:]]*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p' | head -n1)
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          PACKAGE_2_VERSION=$(echo "$PR_BODY" | sed -n 's/.*package-2:[[:space:]]*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p' | head -n1)
          echo "package_2_version=$PACKAGE_2_VERSION" >> $GITHUB_OUTPUT
      - name: Upload artifact
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # zip the test.json file
          zip test.json.zip test.json
          gh release upload ${{ steps.release.outputs.tag_name }} test.json.zip

  test-output:
    runs-on: ubuntu-latest
    name: Test Output
    needs: release-please
    if: ${{ !needs.release-please.outputs.release_created }}
    steps:
      - name: Test Output
        run: |
          echo "candidate version: ${{ needs.release-please.outputs.candidate_version }}"
          echo "package candidate version: ${{ needs.release-please.outputs.package_candidate_version }}"
          echo "package 2 candidate version: ${{ needs.release-please.outputs.package_2_candidate_version }}"

  push-device-software-to-ecr:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/push_device_software_to_ecr.yml
    secrets: inherit
    permissions:
      contents: read
      id-token: write
    with:
      version: ${{ needs.release-please.outputs.version }}

  publish-package-release:
    name: Publish Package Release
    needs: release-please
    if: ${{ needs.release-please.outputs.package_release_created }}
    uses: ./.github/workflows/publish-release.yml
    with:
      package: packages/release-please-test-pkg
    secrets: inherit

  publish-package-2-release:
    name: Publish Package 2 Release
    needs: release-please
    uses: ./.github/workflows/publish-release.yml
    if: ${{ needs.release-please.outputs.package_2_release_created }}
    with:
      package: packages/test-pkg-2
    secrets: inherit

  publish-package-dev-release:
    name: Publish Package Dev Release
    needs: release-please
    uses: ./.github/workflows/publish-dev-release.yml
    if: ${{ !needs.release-please.outputs.package_release_created }}
    with:
      package: packages/release-please-test-pkg
      candidate_version: ${{ needs.release-please.outputs.package_candidate_version }}
    secrets: inherit

  publish-package-2-dev-release:
    name: Publish Package 2 Dev Release
    needs: release-please
    uses: ./.github/workflows/publish-dev-release.yml
    if: ${{ !needs.release-please.outputs.package_2_release_created }}
    with:
      package: packages/test-pkg-2
      candidate_version: ${{ needs.release-please.outputs.package_2_candidate_version }}
    secrets: inherit