name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      package_release_created: ${{ steps.release.outputs['packages/release-please-test-pkg--release_created'] }}
      package_2_release_created: ${{ steps.release.outputs['packages/test-pkg-2--release_created'] }}
      candidate_version: ${{ steps.parse-versions.outputs.root_version }}
      package_candidate_version: ${{ steps.parse-versions.outputs.package_version }}
      package_2_candidate_version: ${{ steps.parse-versions.outputs.package_2_version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          target-branch: main
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
      - name: Parse package versions from PRs
        id: parse-versions
        if: steps.release.outputs.prs != ''
        env:
          PRS_JSON: ${{ steps.release.outputs.prs }}
        run: |
          PRS_JSON2='[{"headBranchName":"release-please--branches--develop","baseBranchName":"develop","number":2512,"title":"chore: release develop","body":"Device release\n---\n\n\n<details><summary>controller: 0.3.0</summary>\n\n## [0.3.0](https://github.com/mytosbio/device/compare/controller-v0.2.2...controller-v0.3.0) (2025-12-18)\n\n\n### Features\n\n* Integrate incubator kit with environment monitoring ([#2499](https://github.com/mytosbio/device/issues/2499)) ([6f22bdd](https://github.com/mytosbio/device/commit/6f22bddfe107ee3ca355f2921fc88fc20a512a97))\n* Use fluentbit for saving environment data in s3 ([#2479](https://github.com/mytosbio/device/issues/2479)) ([1027ccc](https://github.com/mytosbio/device/commit/1027ccce31ee6ab10021af7e7b5face2ffe57518))\n\n\n### Miscellaneous Chores\n\n* Hydrate container references during culture load ([#2510](https://github.com/mytosbio/device/issues/2510)) ([1f913c3](https://github.com/mytosbio/device/commit/1f913c3dfd42abe5aebc037e0752868a79a4a7cc))\n\n\n### Dependencies\n\n* The following workspace dependencies were updated\n  * dependencies\n    * @mytosbio/operations bumped from 0.2.2 to 0.3.0\n</details>\n\n<details><summary>operations: 0.3.0</summary>\n\n## [0.3.0](https://github.com/mytosbio/device/compare/operations-v0.2.2...operations-v0.3.0) (2025-12-18)\n\n\n### Miscellaneous Chores\n\n* **operations:** Synchronize deviceGroup versions\n</details>\n\n<details><summary>device: 0.3.0</summary>\n\n## [0.3.0](https://github.com/mytosbio/device/compare/device-v0.2.2...device-v0.3.0) (2025-12-18)\n\n\n### Features\n\n* **firmware-updater:** don't log error when branch missing ([#2517](https://github.com/mytosbio/device/issues/2517)) ([8476880](https://github.com/mytosbio/device/commit/8476880e432bee18971b80204fbf8fb443eeca00))\n* Integrate incubator kit with environment monitoring ([#2499](https://github.com/mytosbio/device/issues/2499)) ([6f22bdd](https://github.com/mytosbio/device/commit/6f22bddfe107ee3ca355f2921fc88fc20a512a97))\n* Use fluentbit for saving environment data in s3 ([#2479](https://github.com/mytosbio/device/issues/2479)) ([1027ccc](https://github.com/mytosbio/device/commit/1027ccce31ee6ab10021af7e7b5face2ffe57518))\n\n\n### Bug Fixes\n\n* **ci:** Fix version parsing ([#2521](https://github.com/mytosbio/device/issues/2521)) ([0e63eb1](https://github.com/mytosbio/device/commit/0e63eb1b3f19a1f56e2d8bfb5ea9e24a2f3277d4))\n* Return shaker to imaging position after sweep ([#2506](https://github.com/mytosbio/device/issues/2506)) ([144613d](https://github.com/mytosbio/device/commit/144613d33cca45894eda4474d475fb42a45b66ab))\n* **security:** Patch vulnerability CVE-2025-64756 ([#2513](https://github.com/mytosbio/device/issues/2513)) ([5c9ddb7](https://github.com/mytosbio/device/commit/5c9ddb74776dc3d22deb20e4d4ea3c2526db0ba9))\n\n\n### Documentation\n\n* Add versioning docs ([#2514](https://github.com/mytosbio/device/issues/2514)) ([a69ef7e](https://github.com/mytosbio/device/commit/a69ef7e7d517538e2bef8fdab935a63f3ce58614))\n\n\n### Miscellaneous Chores\n\n* Hydrate container references during culture load ([#2510](https://github.com/mytosbio/device/issues/2510)) ([1f913c3](https://github.com/mytosbio/device/commit/1f913c3dfd42abe5aebc037e0752868a79a4a7cc))\n\n\n### Build System\n\n* **auto-pr:** Publish sha- for dev and semver for tagged versions ([#2500](https://github.com/mytosbio/device/issues/2500)) ([2e28d50](https://github.com/mytosbio/device/commit/2e28d505233072a430a8c3e215fc1bcff890f16c))\n* use tighter oidc scope ([#2509](https://github.com/mytosbio/device/issues/2509)) ([97822d5](https://github.com/mytosbio/device/commit/97822d541a1499a4101b7862cb64450ff5245c03))\n</details>\n\n---\nThis PR was generated with [Release Please](https://github.com/googleapis/release-please). See [documentation](https://github.com/googleapis/release-please#release-please).","files":[],"labels":["autorelease: pending"]}]'
          # Extract version numbers from patterns like:
          # <details><summary>root: 0.6.0</summary>
          # <details><summary>package: 1.0.3</summary>
          # <details><summary>package-2: 0.2.1</summary>
          
          ROOT_VERSION=$(echo "$PRS_JSON" | sed -nE 's/.*root:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/p' | head -n1)
          echo "root_version=$ROOT_VERSION" >> $GITHUB_OUTPUT
          PACKAGE_VERSION=$(echo "$PRS_JSON" | sed -nE 's/.*package:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/p' | head -n1)
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          PACKAGE_2_VERSION=$(echo "$PRS_JSON" | sed -nE 's/.*package-2:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/p' | head -n1)
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "package_2_version=$PACKAGE_2_VERSION" >> $GITHUB_OUTPUT
      - uses: actions/checkout@v6
        if: ${{ steps.release.outputs.release_created }}
      - name: Upload artifact
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # zip the test.json file
          zip test.json.zip test.json
          gh release upload ${{ steps.release.outputs.tag_name }} test.json.zip

  test-output:
    runs-on: ubuntu-latest
    name: Test Output
    needs: release-please
    if: ${{ !needs.release-please.outputs.release_created }}
    steps:
      - name: Test Output
        run: |
          echo "candidate version: ${{ needs.release-please.outputs.candidate_version }}"
          echo "package candidate version: ${{ needs.release-please.outputs.package_candidate_version }}"
          echo "package 2 candidate version: ${{ needs.release-please.outputs.package_2_candidate_version }}"

  push-device-software-to-ecr:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/push_device_software_to_ecr.yml
    secrets: inherit
    with:
      version: ${{ needs.release-please.outputs.version }}

  publish-package-release:
    name: Publish Package Release
    needs: release-please
    if: ${{ needs.release-please.outputs.package_release_created }}
    uses: ./.github/workflows/publish-release.yml
    with:
      package: packages/release-please-test-pkg
    secrets: inherit

  publish-package-2-release:
    name: Publish Package 2 Release
    needs: release-please
    uses: ./.github/workflows/publish-release.yml
    if: ${{ needs.release-please.outputs.package_2_release_created }}
    with:
      package: packages/test-pkg-2
    secrets: inherit

  publish-package-dev-release:
    name: Publish Package Dev Release
    needs: release-please
    uses: ./.github/workflows/publish-dev-release.yml
    if: ${{ !needs.release-please.outputs.package_release_created }}
    with:
      package: packages/release-please-test-pkg
      candidate_version: ${{ needs.release-please.outputs.package_candidate_version }}
    secrets: inherit

  publish-package-2-dev-release:
    name: Publish Package 2 Dev Release
    needs: release-please
    uses: ./.github/workflows/publish-dev-release.yml
    if: ${{ !needs.release-please.outputs.package_2_release_created }}
    with:
      package: packages/test-pkg-2
      candidate_version: ${{ needs.release-please.outputs.package_2_candidate_version }}
    secrets: inherit